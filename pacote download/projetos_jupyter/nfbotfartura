import telebot
from ipynb.fs.full.chamar import init
import os
import string
from telebot.types import InlineKeyboardMarkup, InlineKeyboardButton
import time

bot = telebot.TeleBot(chaveapi)
cnpjs,ljs = [],[]
mensagemID,forn = '',''

lista_lojas = ['LJ1 - Guanabara','LJ2 - Primavera','LJ3 - Iguatemi','LJ4 - Flamboyant',
                   'LJ5 - São Paulo','LJ6 - Valinhos','LJ7 - Ouro Verde', 'ESCOLHIDO']

def makeKeyboard(lista):
    markup = InlineKeyboardMarkup()
    if len(lista) == 8:
        for i in range(len(lista)):
            markup.add(InlineKeyboardButton(str(lista[i]), callback_data=str(lista[i])))
    else:
        for i in range(len(lista)):
            markup.add(InlineKeyboardButton(str(lista[i]), callback_data=str(i)))
    return markup


def lojas():
    global lista_lojas,mensagemID
    bot.send_message(mensagemID,"Escolha quais lojas: ", reply_markup = makeKeyboard(lista_lojas))
    
    
def checkforn(forn = 'adep',ljs='0123456'):
    global cnpjs,mensagemID
    perg,achei,aux,cnpj,cnpjs,k = False,False,[],'',[],0
    with open("cnpjs.txt", 'r') as db:
        for linha in db:
            if forn in linha.lower():
                cnpj = linha[-20:]
                cnpj = ''.join([i for i in cnpj if i not in string.punctuation])
                cnpjs.append(int(cnpj))
                aux.append(linha)
                k+=1
                if achei:
                    perg = True
                achei = True
        if not achei:
            bot.send_message(mensagemID, 'não achei esse fornecedor')
            return 0
        if perg:
            if len(aux) == 8:
                aux.append('fornecedor fantasma pra nao atrapalhar o sistema')
            bot.send_message(mensagemID,"Escolha seu fornecedor: ", reply_markup = makeKeyboard(aux))
            return 1
        if achei and perg == False:
            init(int(cnpj),loja=ljs,idz=mensagemID)
            envia(mensagemID)


@bot.message_handler(commands=["notas"])
def notas(mensagem):
    global forn,mensagemID,ljs
    ljs=[]
    mensagemID = mensagem.chat.id
    forn = mensagem.text[7:]
    lojas()
    
    
@bot.message_handler(commands=["numero"])
def numero(mensagem):
    msg = mensagem.text[8:]
    global forn,mensagemID,ljs
    ljs=[]
    mensagemID = mensagem.chat.id
    print(msg)
    for i in range(len(msg)):
        if msg.startswith('0'):
            msg = msg[1:]
    print(msg)
    if len(msg) >= 3 and msg.isdigit() == True:
        init(numero=msg,idz=mensagemID)
        envia(mensagemID)
    else:
        bot.send_message(mensagemID,"Não use letras ou menos de 3 números")

    
@bot.message_handler(func=lambda message: True)
def resposta(mensagem):
    text = '''
    Olá! Seja bem vindo ao NF Fartura Bot
    :D  Estes são os meus Comandos:

    "/notas fornecedor" pra ver notas do fornecedor
    =-=-=-=-=-=-=-=-=-=  OU =-=-=-=-=-=-=-=-=-=
    "/notas cnpj" (xx.xxx.xxx/xxxx-xx)
    =-=-=-=-=-=-=-=-=-=  OU =-=-=-=-=-=-=-=-=-=
    "/numero 123456" (número da sua nota)
    '''
    bot.reply_to(mensagem, text)
    
    
@bot.callback_query_handler(func=lambda call: True)
def handle_query(call):
    global lista_lojas,ljs,forn
    if call.data.isdigit():
        iniciar(call.data)
    else:
        if call.data == 'ESCOLHIDO' and ljs:
            checkforn(forn,ljs)
        if str(lista_lojas.index(call.data)) not in ljs and call.data != 'ESCOLHIDO':
            ljs.append(str(lista_lojas.index(call.data)))
        
        
def envia(mensagemID):
    k=0
    pasta = fr'C:\Users\pdv\projetos_jupyter\retorno\\{mensagemID}'
    for diretorio, subpastas, arquivos in os.walk(pasta):
        if not arquivos:
            text = 'Desculpe, não achei notas desse fornecedor nessa loja'
            bot.send_message(mensagemID,text)
            return 0
        for arquivo in arquivos:
            j=str(k)+'.'
            x = f'{pasta}\\nota{j}png'
            k+= 1
            bot.send_photo(mensagemID, photo=open(x,'rb'))
    text = 'pronto :)'
    bot.send_message(mensagemID,text)
        
    
def iniciar(calldata):
    global cnpjs,mensagemID,ljs
    try:
        r = init(cnpjs[int(calldata)],loja=ljs,idz=mensagemID)
        envia(mensagemID)
    except Exception as e:
        print(e)
        bot.reply_to(mensagemID, 'não achei notas')
    if r == "não achei esse":
        bot.reply_to(mensagemID, r)
        
        
while True:
    try:
        bot.polling(none_stop=True, interval=0, timeout=0)
    except:
        time.sleep(10)